# Webフォームと既存GASの統合手順

## 問題の解決方法

### 1. 修正したファイル

#### public/index.html
- `mode: 'no-cors'`を削除し、通常のCORS対応モードに変更
- レスポンスの確認処理を追加
- Content-Typeを`text/plain`に変更（GASの仕様に対応）

### 2. 既存のGASに追加するコード

`doPost_integration.gs`の内容を既存のGASファイル（出荷証明中央データーベースコード）に追加してください。

#### 追加する主な関数：
- `doPost(e)` - Webフォームからのリクエストを処理
- `generateControlIdForForm(sheet)` - 管理番号を生成
- `buildRowDataForForm(controlId, data)` - データベース構造に合わせたデータを構築
- `formatLatestRowForForm(sheet)` - 最新行のフォーマット設定
- `sendNotificationEmailForForm(data, controlId)` - 通知メール送信
- `doGet()` - テスト用（動作確認）

### 3. GASでの設定手順

1. **Google Apps Scriptエディタを開く**
   - 既存のスプレッドシートから「拡張機能」→「Apps Script」

2. **コードを追加**
   - `doPost_integration.gs`の内容を既存のコードの最後に追加

3. **通知メールアドレスを設定**
   - `sendNotificationEmailForForm`関数内の`notificationEmail`を実際のメールアドレスに変更

4. **デプロイを更新**
   - 「デプロイ」→「デプロイを管理」
   - 既存のデプロイを編集
   - 「新しいバージョン」を作成
   - 説明に「Webフォーム連携機能追加」と記入
   - 「デプロイ」をクリック

### 4. 権限の確認

デプロイ設定で以下を確認：
- **実行ユーザー**: 自分
- **アクセスできるユーザー**: 全員

### 5. 動作確認

1. **GASのテスト**
   - ブラウザでWeb App URLにアクセス
   - `{"status":"ok","message":"出荷証明書作成依頼システムが正常に動作しています"...}`が表示されれば正常

2. **Webフォームからのテスト**
   - public/index.htmlをブラウザで開く
   - テストデータを入力して送信
   - 成功メッセージが表示されることを確認
   - スプレッドシートにデータが追加されていることを確認

### 6. トラブルシューティング

#### エラーが発生する場合：
1. **ブラウザの開発者ツールでコンソールを確認**
   - CORSエラーが出ている場合 → GASのデプロイ設定を再確認
   - 500エラーが出ている場合 → GASのログを確認

2. **GASのログを確認**
   - Apps Scriptエディタで「実行数」→「ログを表示」
   - エラーの詳細を確認

3. **よくある問題**
   - シート名が一致していない → `DB_NAME`の値を確認
   - 権限エラー → デプロイ設定の「アクセスできるユーザー」を確認
   - データ構造の不一致 → スプレッドシートの列数を確認

### 7. 注意事項

- 既存のGAS機能（T2処理など）には影響しません
- doPost関数は新規追加なので、既存の処理と競合しません
- LockServiceにより同時実行の制御も実装済み